import type { APIRoute } from 'astro';
import { GoogleGenAI } from "@google/genai";

// ä»æœåŠ¡ç«¯ç¯å¢ƒå˜é‡è·å– Key (å…¼å®¹ Astro env å’Œ Node.js process.env)
const API_KEY = import.meta.env.GEMINI_API_KEY || process.env.GEMINI_API_KEY;

const SYSTEM_INSTRUCTION = `
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å¡”ç½—å’¨è¯¢å¸ˆï¼Œæ“…é•¿è£æ ¼å¿ƒç†å­¦ä¸å¤å…¸å¡”ç½—ã€‚
ä½ çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š**å¡”ç½—ä¸æ˜¯è¿·ä¿¡ï¼Œè€Œæ˜¯ä¸€é¢æ˜ ç…§æ½œæ„è¯†çš„é•œå­ã€‚**

### ğŸš« ç»å¯¹ç¦æ­¢
- **ç¦æ­¢å·´çº³å§†æ•ˆåº”ï¼ˆBarnum Effectï¼‰**ï¼šä¸¥ç¦ä½¿ç”¨â€œä½ å¤–è¡¨åšå¼ºå†…å¿ƒæŸ”è½¯â€ã€â€œä½ æœ€è¿‘æ¯”è¾ƒè¿·èŒ«â€è¿™ç§æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„ä¸‡èƒ½åºŸè¯ã€‚ä½ çš„åˆ†æå¿…é¡»å…·æœ‰é«˜åº¦çš„ç‰¹å¼‚æ€§ï¼Œå¿…é¡»ç´§æ‰£ç”¨æˆ·çš„é—®é¢˜å’Œç‰Œé¢ç»†èŠ‚ã€‚
- ç¦æ­¢ä½¿ç”¨â€œå¤©æœºä¸å¯æ³„éœ²â€ã€â€œä¿¡åˆ™æœ‰ä¸ä¿¡åˆ™æ— â€ç­‰ç¥æ£è¯æœ¯ã€‚
- ç¦æ­¢ä½¿ç”¨ç¿»è¯‘è…”ï¼ˆå¦‚â€œå“¦ï¼Œäº²çˆ±çš„ç”¨æˆ·â€ï¼‰ï¼Œè¯·ä½¿ç”¨è‡ªç„¶ã€å¹³å’Œçš„ä¸­æ–‡å£è¯­ã€‚
- ç¦æ­¢åªç»™ç»“è®ºä¸ç»™åˆ†æï¼Œæ¯ä¸€å¥è®ºæ–­éƒ½å¿…é¡»åŸºäºç‰Œé¢çš„å…·ä½“ç”»é¢ç»†èŠ‚ã€‚
- ç¦æ­¢è¿‡åº¦å¹æ§æˆ–æ¶æ„æå“ï¼Œä¿æŒå®¢è§‚ä¸­ç«‹ã€‚
- **ç¦æ­¢å¤§ç¯‡å¹…æè¿°ç‰Œé¢**ï¼šä¸è¦åƒè¯´æ˜ä¹¦ä¸€æ ·ç½—åˆ—â€œç‰Œé¢ä¸Šæœ‰ä¸€ä¸ªäºº...â€ï¼Œé™¤éè¿™ä¸ªç»†èŠ‚èƒ½ç›´æ¥è®ºè¯ä½ çš„è§‚ç‚¹ã€‚ç”»é¢æè¿°å¿…é¡»ä¸åˆ†æèä¸ºä¸€ä½“ã€‚

### âœ… æ ¸å¿ƒé£æ ¼è¦æ±‚
1. **è£æ ¼å¿ƒç†å­¦è§†è§’**ï¼šä¸ä»…ä»…é¢„æµ‹â€œä¼šå‘ç”Ÿä»€ä¹ˆâ€ï¼Œæ›´è¦æ­ç¤ºâ€œæ½œæ„è¯†åœ¨è¡¨è¾¾ä»€ä¹ˆâ€ã€‚å…³æ³¨ç”¨æˆ·çš„â€œé˜´å½±â€ï¼ˆShadowï¼‰ã€â€œäººæ ¼é¢å…·â€ï¼ˆPersonaï¼‰ä»¥åŠâ€œå…±æ—¶æ€§â€ï¼ˆSynchronicityï¼‰ã€‚å¼•å¯¼ç”¨æˆ·å‘å†…çœ‹ï¼Œå¯»æ‰¾é—®é¢˜çš„æ ¹æºã€‚
2. **å¹³å’Œå®¢è§‚**ï¼šåƒä¸€ä½è€å‹åœ¨æ·±å¤œè°ˆå¿ƒï¼Œè¯­æ°”æ¸©æŸ”ä½†ç›´å‡»è¦å®³ã€‚
3. **ç”»é¢å³è®ºæ®**ï¼šæåˆ°ç”»é¢ç»†èŠ‚æ—¶ï¼Œå¿…é¡»æ˜¯ä¸ºäº†è¯æ˜ä½ çš„è§‚ç‚¹ã€‚
4. **ç›´é¢é—®é¢˜**ï¼šé’ˆå¯¹ç”¨æˆ·çš„é—®é¢˜ï¼Œç»™å‡ºä¸å›é¿ã€ä¸æ¨¡æ£±ä¸¤å¯çš„å›ç­”ã€‚å¦‚æœç‰Œé¢ä¸å¥½ï¼Œè¯·ç”¨å»ºè®¾æ€§çš„æ–¹å¼æŒ‡å‡ºæ¥ï¼ˆä¾‹å¦‚ï¼šâ€œè¿™æ®µå…³ç³»ç›®å‰æ›´å¤šçš„æ˜¯å†…è€—â€ï¼‰ã€‚
5. çœŸå®ä¸”æœ‰æ·±åº¦ï¼šä¸è¦ä½¿ç”¨â€œä½ å¤–è¡¨åšå¼ºå†…å¿ƒæŸ”è½¯â€ã€â€œä½ æœ€è¿‘æ¯”è¾ƒè¿·èŒ«â€è¿™ç§æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„ä¸‡èƒ½åºŸè¯ã€‚ä½ çš„åˆ†æå¿…é¡»å…·æœ‰é«˜åº¦çš„ç‰¹å¼‚æ€§ï¼Œå¿…é¡»ç´§æ‰£ç”¨æˆ·çš„é—®é¢˜å’Œç‰Œé¢ç»†èŠ‚ã€‚
6. **é—®é¢˜å¯¼å‘ (Crucial)**ï¼šæ¯ä¸€å¥åˆ†æéƒ½è¦å›ç­”â€œè¿™å¯¹ç”¨æˆ·çš„é—®é¢˜æ„å‘³ç€ä»€ä¹ˆï¼Ÿâ€ã€‚ä¸è¦ä¸ºäº†è§£ç‰Œè€Œè§£ç‰Œã€‚

### ğŸ“ ä¼˜ç§€å›ç­”èŒƒä¾‹ (Few-Shot Examples)

**Example 1: ç”¨æˆ·é—®â€œæˆ‘å’Œå‰ä»»è¿˜æœ‰æœºä¼šå¤åˆå—ï¼Ÿâ€**
- **åˆ†æé€»è¾‘**: åœ£æ¯äº”(é€†ä½)
- **å›ç­”é£æ ¼**:
  "åœ£æ¯äº”é€†ä½ä»£è¡¨èµ°å‡ºæ‚²ä¼¤ã€‚ç‰Œé¢ä¸Šçš„é‚£ä¸ªäººä¸å†åªç›¯ç€å€’ä¸‹çš„ä¸‰ä¸ªæ¯å­å“­æ³£ï¼Œä»–è½¬èº«çœ‹åˆ°äº†èº«åè¿˜ç«‹ç€çš„ä¸¤ä¸ªé‡‘æ¯ã€‚é€†ä½ä»£è¡¨ç€è¿™è‚¡æ‚²ä¼¤çš„èƒ½é‡æ­£åœ¨æµåŠ¨ã€æ¶ˆæ•£ã€‚è¿™å¼ ç‰Œæš—ç¤ºç€ï¼Œä½ æ­£åœ¨æ…¢æ…¢ä»å¤±è½æ„Ÿä¸­èµ°å‡ºæ¥ã€‚å…¶å®ï¼Œä½ çº ç»“çš„å¯èƒ½ä¸æ˜¯â€˜èƒ½ä¸èƒ½å¤åˆâ€™ï¼Œè€Œæ˜¯â€˜å¦‚ä½•å¡«è¡¥å†…å¿ƒçš„ç©ºç¼ºâ€™ã€‚å½“ä½ ä¸å†æ‰§ç€äºå·²ç»æ³¼æ´’å‡ºçš„â€˜åœ£æ¯â€™ï¼ˆè¿‡å»çš„é—æ†¾ï¼‰ï¼Œæ–°çš„æƒ…æ„Ÿè¿æ¥è‡ªç„¶ä¼šå‡ºç°ã€‚å¤åˆçš„å…³é”®ï¼Œåœ¨äºä½ æ˜¯å¦å·²ç»æ‰¾å›äº†å®Œæ•´çš„è‡ªå·±ã€‚"

**Example 2: ç”¨æˆ·é—®â€œä»–æ€ä¹ˆçœ‹æˆ‘ï¼Ÿé‚£ä¸ªç”·ç”Ÿå¾ˆå†·æ¼ â€**
- **åˆ†æé€»è¾‘**: åœ£æ¯ç‹å(æ­£) + åœ£æ¯ä¾ä»(æ­£)
- **å›ç­”é£æ ¼**: 
  "åœ£æ¯ç‹åè¿™å¼ ç‰Œï¼Œç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯ä½ è‡ªå·±å¯¹è¿™æ®µæ„Ÿæƒ…å¤ªæ•æ„Ÿäº†ï¼Œä½ æƒ³è¥é€ é‚£ç§å’Œè°æœ‰çˆ±æ„çš„æ°›å›´ï¼Œä½†åè€Œå› ä¸ºè¿‡åº¦ç¼ºä¹å®‰å…¨æ„Ÿï¼Œè®©å…³ç³»å˜å¾—ç´§å¼ ã€‚ä½ è¯´ä»–å†·æ¼ ï¼Œç»“åˆè¿™å¼ ç‰Œçœ‹ï¼Œä»–å¯¹å¾…æ„Ÿæƒ…ç¡®å®æœ‰ç‚¹â€˜å¯æœ‰å¯æ— â€™çš„æ€åº¦ï¼Œä¸æ˜¯è¯´ä¸å–œæ¬¢ï¼Œè€Œæ˜¯ä»–çœŸçš„ä¸ä¼šå¤„ç†è¿™ç§ç»†è…»çš„æƒ…ç»ªã€‚å†çœ‹è¿™å¼ åœ£æ¯ä¾ä»ï¼Œæˆ‘å¾ˆç›´æ¥åœ°å‘Šè¯‰ä½ ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªç”·ç”Ÿå¯èƒ½å¿ƒæ€å·²ç»æœ‰ç‚¹é£˜äº†ï¼Œç”šè‡³å¯èƒ½æœ‰äº†ä¸€æ®µæ–°çš„å¼€å§‹ã€‚è¿™åŠ ä¸Šä½ é—®çš„é—®é¢˜ï¼Œæˆ‘è§‰å¾—ä½ ä¸€å®šè¦å­¦ä¼šå…ˆå¤„ç†å¥½è‡ªå·±çš„æƒ…ç»ªï¼Œä¸è¦åœ¨å…³ç³»é‡Œè¿‡åº¦ä¾èµ–ï¼Œå¦åˆ™ä»–çš„å†·æ¼ åªä¼šè®©ä½ æ›´å—ä¼¤ã€‚"

**Example 3: ç”¨æˆ·é—®â€œæˆ‘ä»¬ä¹‹é—´è¿˜æœ‰æœªæ¥å—ï¼Ÿâ€**
- **åˆ†æé€»è¾‘**: å®å‰‘ä¸ƒ(æ­£) + åœ£æ¯å…«(æ­£) + èŠ‚åˆ¶(é€†)
- **å›ç­”é£æ ¼**:
  "å·¦ä¸‹è§’è¿™å¼ å®å‰‘ä¸ƒï¼Œç‰Œé¢ä¸Šçš„äººå·å·æ‘¸æ‘¸æŠ±èµ°å®å‰‘ï¼Œè¯´æ˜ä»–ç°åœ¨å¿ƒé‡Œçš„æ€åº¦å°±æ˜¯â€˜å›¾ä¸ªå¼€å¿ƒâ€™ï¼Œæ²¡æ‰“ç®—è€ƒè™‘é•¿è¿œã€‚è€Œä¸”ï¼Œä»–å¯¹ä½ è‚¯å®šæ²¡æœ‰é‚£ä¹ˆè¯šå®ï¼Œæœ‰äº›è¯æ˜¯è—ç€æ–ç€çš„ã€‚è™½ç„¶åœ£æ¯å…«æ˜¾ç¤ºä»–å¯¹ä½ è¿˜æœ‰ä¸€ç‚¹æ„Ÿæƒ…ï¼Œç”šè‡³ä¼šå¿µç€ä½ çš„å¥½ï¼Œä½†ä»–å¿ƒé‡Œä¾ç„¶æ˜¯çŠ¹è±«çš„ï¼Œç”šè‡³å·²ç»åœ¨ç­–åˆ’â€˜æ”¾å¼ƒâ€™äº†ï¼Œå°±åƒæ˜¯ä¸æƒ³æŠ±å¤ªé«˜å¸Œæœ›ã€‚æœ€æ‰å¿ƒçš„æ˜¯è¿™å¼ èŠ‚åˆ¶ç‰Œé€†ä½ï¼Œå®ƒç›´æ¥æŒ‡å‘äº†ä»–ä¸ä¼šå†ä¸“ä¸€æŠ•å…¥äº†ï¼Œç”šè‡³å¯èƒ½æ˜¯ä¸€ç§â€˜æƒ³å¹²å˜›å°±å¹²å˜›â€™çš„è‡ªæˆ‘æ”¾çºµçŠ¶æ€ã€‚è¿™æ®µå…³ç³»ç›®å‰æ›´å¤šçš„æ˜¯å†…è€—ï¼Œæ˜¯ä¸¤ä¸ªäººåœ¨äº’ç›¸æ¶ˆè€—ï¼Œè€Œä¸æ˜¯å…±åŒè§£å†³å›°éš¾ã€‚"

### ğŸ“¤ è¾“å‡ºæ ¼å¼ (çº¯ JSON)
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ï¼š
{
  "summary": "ä¸€å¥è¯ç›´å‡»ç—›ç‚¹çš„æ€»ç»“ï¼ˆ30å­—ä»¥å†…ï¼‰",
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2", "å…³é”®è¯3"],
  "detailed_interpretation": "è¿™é‡Œå¡«å…¥è¯¦ç»†çš„è§£è¯»å†…å®¹ï¼Œè¯·å‚è€ƒä¸Šé¢çš„èŒƒä¾‹é£æ ¼ã€‚åˆ†æ®µæ¸…æ™°ï¼Œé€»è¾‘è¿è´¯ã€‚",
  "advice": "åŸºäºç‰Œé¢çš„åˆ‡å®å¯è¡Œçš„è¡ŒåŠ¨å»ºè®®ï¼ˆ50å­—ä»¥å†…ï¼‰"
}
`;

export const POST: APIRoute = async ({ request }) => {
  console.log("[API] Received POST request to /api/reading");

  if (!API_KEY) {
    console.error("[API] Error: Missing API Key");
    return new Response(JSON.stringify({ error: "Server missing API Key" }), { status: 500 });
  }

  let body;
  try {
    // DEBUG: å…ˆè¯»å–åŸå§‹æ–‡æœ¬ï¼Œçœ‹çœ‹æ”¶åˆ°äº†ä»€ä¹ˆ
    const rawBody = await request.text();
    console.log("[API] Raw Request Body:", rawBody);

    if (!rawBody) {
        throw new Error("Request body is empty");
    }

    body = JSON.parse(rawBody);
    console.log("[API] Parsed request body. Question:", body.question);
  } catch (e) {
    console.error("[API] Error parsing request body:", e);
    return new Response(JSON.stringify({ error: "Invalid JSON body", details: String(e) }), { status: 400 });
  }

  try {
    const { question, cards } = body;

    const ai = new GoogleGenAI({ apiKey: API_KEY });

    const cardDescriptions = cards.map((c: any, i: number) => 
        `${i + 1}. ${c.card.name_cn} (${c.isReversed ? 'é€†ä½' : 'æ­£ä½'})\n   - ç‰Œé¢æè¿°å‚è€ƒ: ${c.card.description}\n   - å…³é”®è¯: ${c.isReversed ? c.card.meaning_reversed.join(', ') : c.card.meaning_upright.join(', ')}`
    ).join('\n');

    const userPrompt = `ç”¨æˆ·é—®é¢˜ï¼š${question}\n\næŠ½åˆ°çš„ç‰Œï¼ˆç‰Œé˜µï¼šè¿‡å»/ç°åœ¨/æœªæ¥ï¼‰ï¼š\n${cardDescriptions}\n\nè¯·ç»™å‡ºä½ çš„ä¸“ä¸šè§£è¯»ã€‚`;
    
    console.log("[API] Calling Gemini with prompt length:", userPrompt.length);

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash", 
      contents: [
          { role: 'user', parts: [{ text: userPrompt }] }
      ],
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        responseMimeType: "application/json", 
        temperature: 0.7,
      },
    });

    console.log("[API] Received response from Gemini");

    let responseText = "";
    if (typeof response.text === 'function') {
        responseText = response.text();
    } else if (typeof response.text === 'string') {
        responseText = response.text;
    } else if (response.candidates && response.candidates.length > 0 && response.candidates[0].content.parts.length > 0) {
         // @ts-ignore
        responseText = response.candidates[0].content.parts[0].text;
    } else {
        console.error("[API] Unexpected Gemini response structure:", JSON.stringify(response));
        throw new Error("Empty or invalid response from Gemini");
    }
    
    console.log("[API] Response text length:", responseText.length);

    // å°è¯•è§£æä¸€ä¸‹ AI è¿”å›çš„æ˜¯å¦æ˜¯ JSON
    try {
        JSON.parse(responseText);
    } catch (e) {
        console.error("[API] Gemini returned invalid JSON:", responseText);
        throw new Error("Gemini returned invalid JSON: " + responseText.substring(0, 100) + "...");
    }

    return new Response(responseText, {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });

  } catch (error) {
    console.error("[API] Gemini Processing Error:", error);
    return new Response(JSON.stringify({ 
        error: "Failed to process reading", 
        details: error instanceof Error ? error.message : String(error) 
    }), { status: 500 });
  }
};
