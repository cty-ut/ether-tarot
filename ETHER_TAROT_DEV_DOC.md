# 🔮 Ether Tarot (以太塔罗)
## —— 移动端沉浸式 AI 占卜平台开发规划书

### 1. 核心理念：用户体验至上 (Customer Obsession)
在塔罗牌产品中，**“准”是主观的，“快”和“美”是客观的**。
我们的技术目标是：**0.1秒的加载延迟都会破坏神性。**

*   **仪式感 (Ritual):** 洗牌、切牌、翻牌的物理反馈必须真实。
*   **沉浸感 (Immersion):** 杜绝任何“正在加载中”的系统级 UI，所有等待都必须包装成“神秘仪式”。
*   **即时性 (Immediacy):** AI 的反馈必须像流动的泉水，而不是一次性倾倒的文本块。

---

### 2. 标准塔罗占卜业务流程 (The Flow)

我们将古老的神秘学仪式，完美映射到数字交互中。

#### 2.1 步骤一：冥想与提问 (Meditation & Query)
*   **传统仪式:** 占卜者在心中默念问题，摒弃杂念，集中精神。问题通常是开放式的（如“我该如何改善关系”而非“他爱我吗”）。
*   **App 实现:**
    *   全屏呼吸光效引导用户调整呼吸频率。
    *   提供“问题指引”模板，帮助用户修正提问方式（例如将“是/否”问题转化为“建议/方向”问题）。
    *   必须长按“开始”按钮3秒，强制用户进行短暂的静心。

#### 2.2 步骤二：洗牌 (The Shuffle)
*   **传统仪式:** 将牌面朝下，双手在桌面上顺时针搓动，目的是打乱牌序并注入问卜者的能量（混沌化）。
*   **App 实现:**
    *   **物理引擎:** 78张牌散落在屏幕上，用户手指滑动会产生真实的物理碰撞和散开效果。
    *   **真随机:** 每一张牌的位置都由随机算法实时计算，而非预设动画。

#### 2.3 步骤三：切牌 (The Cut)
*   **传统仪式:** 将洗好的牌堆拢，用左手（直觉之手）将牌分成两叠或三叠，再重新叠放。象征着潜意识的介入和决断。
*   **App 实现:**
    *   用户将散乱的牌“聚拢”成一堆。
    *   提示用户双击牌堆，牌堆自动切分并重组，伴随轻微震动反馈。

#### 2.4 步骤四：选牌阵 (Spread Selection)
*   **传统仪式:** 根据问题的类型选择不同的牌阵。
*   **App 核心牌阵:**
    *   **单张牌 (One Card):** 适用于“今日指引”或简单的“是/否”倾向。
    *   **圣三角 (The Trinity):** 最经典牌阵。
        1.  **过去/现状:** 问题的成因。
        2.  **现在/挑战:** 面临的阻碍。
        3.  **未来/建议:** 结果的趋向。
    *   **凯尔特十字 (Celtic Cross):** *（进阶功能，二期开发）* 用于深度分析复杂局势。

#### 2.5 步骤五：抽牌 (The Draw)
*   **传统仪式:** 从扇形展开的牌中凭直觉抽出特定数量的牌，牌面依然朝下。
*   **App 实现:**
    *   牌堆呈扇形展开。
    *   用户手指滑过牌背时，牌会微微浮起（Hover效果）。
    *   选中并拖拽出牌，放入指定的牌阵卡槽中。

#### 2.6 步骤六：开牌与解牌 (The Reveal & Reading)
*   **传统仪式:** 依次翻开牌面，解读画面象征、正逆位含义，并结合问题进行综合叙述。
*   **App 实现:**
    *   **单击翻牌:** 牌面翻转，展示高清大图。
    *   **AI 导师:** Gemini 1.5 Flash 扮演“导师”角色，先解读单张牌意，再结合全部牌面进行综述。

---

### 3. 终极技术架构 (The "Perfect" Stack)

为了实现极致的手机端性能与体验，我们采用 **Astro + React (Islands)** 架构。

*   **骨架 (Framework): Astro**
    *   *作用:* 实现 MPA (多页应用) 的首屏秒开。首页、历史记录页、关于页生成纯 HTML。
    *   *客户价值:* 用户点开链接瞬间就能看到页面，无需等待 JS 下载，留存率极大提升。
*   **肌肉 (Interactive UI): React + Framer Motion**
    *   *作用:* 仅在“占卜桌面”这一核心区域加载 React。
    *   *配置:* 使用 Framer Motion 的 `LayoutGroup` 处理复杂的卡牌飞入飞出动画。
*   **神经系统 (State): Nano Stores**
    *   *作用:* 极简状态管理。
    *   *场景:* 比如用户在 Astro 渲染的静态 Header 上点击“静音”，React 渲染的牌桌组件能立即响应，无需重型 Context。
*   **大脑 (Intelligence): Google Gemini 1.5 Flash**
    *   *作用:* 极速推理。
    *   *策略:* 利用其 100万 Context Window，预埋完整的塔罗牌意数据库，确保解读的专业性。

---

### 4. 详细功能模块与体验设计

#### 4.1 阶段一：静心与连接 (Landing & Setup)
*   **视觉:** 全黑背景，只有中心微弱的呼吸灯光效（CSS Animation）。
*   **交互:**
    *   用户无需登录（UUID 存本地 localStorage），降低门槛。
    *   输入框：“心中默念你的问题...”（支持语音输入预留接口）。
    *   **冥想按钮:** 长按按钮 3 秒进入占卜，期间播放短促的空灵音效（Web Audio API）。
*   **技术细节:**
    *   这 3 秒不仅是仪式，更是**预加载资源**（Preload 78张牌的缩略图）的黄金时间。

#### 4.2 阶段二：洗牌与切牌 (The Shuffle - 核心难点)
这是最考验性能的环节。
*   **视觉:** 78张牌背朝上，呈扇形或散乱堆叠。
*   **交互:**
    *   **真随机洗牌:** 用户手指在屏幕上滑动，卡牌跟随手指扰动（基于 Framer Motion 的 `drag` 属性）。
    *   **切牌:** 提示用户双击牌堆完成切牌。
*   **体验优化:**
    *   **Haptic Feedback:** 利用 `navigator.vibrate()`，每当两张牌碰撞或洗牌时，手机轻微震动。这是“手感”的关键。

#### 4.3 阶段三：抽牌 (The Draw)
*   **视觉:** 牌背呈扇形展开 (Fan Layout)。
*   **交互:**
    *   用户拖出 1 张或 3 张牌（取决于牌阵）。
    *   被选中的牌会有“浮起”的高亮效果。
    *   放置到指定的卡槽（Drop Zone）中，伴随清脆的落桌声。

#### 4.4 阶段四：揭示与解读 (The Reveal & Interpretation)
*   **翻转动画:** 点击卡牌，卡牌沿 Y 轴翻转 180 度。这里必须使用 3D CSS (`transform-style: preserve-3d`)。
*   **AI 流式传输 (Streaming):**
    *   翻开牌的瞬间，前端立即向 Gemini 1.5 Flash 发送请求。
    *   **延迟掩盖:** 在 AI 生成第一个字之前（约 0.5-1秒），显示“星象正在汇聚...”的粒子特效。
    *   **打字机效果:** 文本必须一个字一个字蹦出来，速度跟随标点符号微调（句号停顿稍长）。
*   **内容分层 (Structured Output):**
    *   不要一大段文字。
    *   **第一层:** 核心关键词（如：**改变**、**新生**）。
    *   **第二层:** 牌面直意。
    *   **第三层:** 结合用户问题的深度洞察。

---

### 5. AI 灵性调优 (AI Spiritual Tuning)

为了让 AI 摆脱“机器味”，必须进行 Few-Shot Prompting (少样本提示)。

#### 5.1 System Prompt 核心指令
> "你是一位拥有20年经验的神秘学导师，精通荣格心理学与古典塔罗。你的职责不是预测未来，而是通过牌面象征，揭示用户潜意识中的盲点。你的语气应当是温和、包容且具有启发性的（Inspiring）。避免使用宿命论的绝对断言（如‘你肯定会失败’），而应提供建设性的指引。必须以 JSON 格式输出。"

#### 5.2 真人塔罗师样例 (Few-Shot Examples)

 **Example 1: 圣杯五 (逆位) - 关于“失恋”的提问**
*   **用户问题:** "我和前任还有机会复合吗？"
*   **Bad AI Response:** "圣杯五逆位代表走出悲伤。你有机会复合，但要看缘分。"
*   **Good AI Response (Spiritual):**
    *   **核心词:** 疗愈、转机、自我接纳
    *   **牌面直意:** "牌面上的那个人不再只盯着倒下的三个杯子哭泣，他转身看到了身后还立着的两个金杯。逆位代表着这股悲伤的能量正在流动、消散。"
    *   **深度洞察:** "这张牌暗示着，你正在慢慢从失落感中走出来。其实，你纠结的可能不是‘能不能复合’，而是‘如何填补内心的空缺’。当你不再执着于已经泼洒出的‘圣杯’（过去的遗憾），新的情感连接自然会出现。复合的关键，在于你是否已经找回了完整的自己。"

**Example 2: 圣杯王后 + 圣杯侍从 - 关于“他怎么看我”的提问 (口语化风格)**
*   **用户问题:** "他现在对我是什么感觉？那个男生很冷漠。"
*   **Good AI Response (Spiritual & Conversational):**
    *   **核心词:** 敏感、冷漠回避、新的开始
    *   **牌面直意:** "圣杯王后这张牌，给我的感觉就是你自己对这段感情太敏感了，你想营造那种和谐有爱意的氛围，但反而因为过度缺乏安全感，让关系变得紧张。你说他冷漠，结合这张牌看，他对待感情确实有点‘可有可无’的态度，不是说不喜欢，而是他真的不会处理这种细腻的情绪。"
    *   **深度洞察:** "再看这张圣杯侍从，我很直接地告诉你，我感觉这个男生可能心思已经有点飘了，甚至可能有了一段新的开始。这加上你问的问题，我觉得宝宝你一定要学会先处理好自己的情绪，不要在关系里过度依赖，否则他的冷漠只会让你更受伤。"

**Example 3: 宝剑七 + 圣杯八 + 节制 (逆位) - 关于“关系走向”的综合解读**
*   **用户问题:** "我们之间还有未来吗？"
*   **Good AI Response (Spiritual & Sharp):**
    *   **核心词:** 不诚实、犹豫放弃、自我放纵
    *   **牌面直意:** "左下角这张宝剑七，牌面上的人偷偷摸摸抱走宝剑，说明他现在心里的态度就是‘图个开心’，没打算考虑长远。而且，他对你肯定没有那么诚实，有些话是藏着掖着的。"
    *   **深度洞察:** "虽然圣杯八显示他对你还有一点感情，甚至会念着你的好，但他心里依然是犹豫的，甚至已经在策划‘放弃’了，就像是不想抱太高希望。最扎心的是这张节制牌逆位，它直接指向了他不会再专一投入了，甚至可能是一种‘想干嘛就干嘛’的自我放纵状态。这段关系目前更多的是内耗，是两个人在互相消耗，而不是共同解决困难。"

---

### 6. 数据结构设计 (TypeScript)

为了保证逻辑严密，我们需要严格定义数据。

```typescript
// 卡牌花色
type Suit = 'wands' | 'cups' | 'swords' | 'pentacles' | 'major';

// 卡牌定义
interface TarotCard {
  id: number; // 0-77
  name_en: string;
  name_cn: string;
  suit: Suit;
  image_url_low: string; // 模糊图 (WebP, 5KB)
  image_url_high: string; // 高清图 (WebP, 100KB)
  meaning_upright: string[]; // 正位关键词
  meaning_reversed: string[]; // 逆位关键词
  description: string; // 画面描述（用于发给 AI 做参考）
}

// 抽牌结果
interface DrawResult {
  cardId: number;
  isReversed: boolean; // 是否逆位
  position: number; // 在牌阵中的位置 (例如 0=过去, 1=现在, 2=未来)
}

// AI 返回的结构 (JSON Mode)
interface AIResponse {
  summary: string; // 一句话总结
  keywords: string[]; // 3个高亮词
  detailed_interpretation: string; // 详细解读
  advice: string; // 行动建议
}
```

---

### 7. 性能极致优化策略 (Web Vitals)

因为我们要适配手机端，必须锱铢必较。

1.  **图片策略 (Crucial):**
    *   78张高清图大约 10MB+，绝对不能一次加载。
    *   **策略:** 只有当卡牌**翻转**过来时，才请求该张牌的高清图。
    *   洗牌阶段使用的全部是 `image_url_low`（模糊的小图），通过 CSS `backdrop-filter: blur` 渲染，反而有一种朦胧美。

2.  **动画性能:**
    *   所有动画仅通过 `transform` 和 `opacity` 实现，绝不触发布局重排 (Reflow)。
    *   使用 `will-change: transform` 提示浏览器开启 GPU 加速。

3.  **Gemini 优化:**
    *   System Prompt 中加入：“请用 JSON 格式返回，不要任何 Markdown 代码块标记”。
    *   利用 Vercel Edge Functions 部署 API 路由，缩短网络链路。

---

### 8. 项目文件目录规划 (Astro 结构)

```text
src/
├── components/
│   ├── react/              # React 交互组件 (Islands)
│   │   ├── Deck.tsx        # 牌堆 (Framer Motion)
│   │   ├── Card.tsx        # 单张卡牌 (翻转逻辑)
│   │   ├── ReadingBox.tsx  # AI 文字流显示区域
│   │   └── StarField.tsx   # 背景粒子效果
│   └── astro/              # 静态组件
│       ├── Header.astro
│       └── Footer.astro
├── layouts/
│   └── Layout.astro        # 全局 HTML 骨架
├── pages/
│   ├── index.astro         # 首页 (Landing)
│   ├── reading.astro       # 占卜页 (加载 React 岛屿)
│   └── history.astro       # 历史记录
├── stores/
│   ├── tarotStore.ts       # Nano Stores 状态
│   └── userStore.ts        # 用户偏好
├── utils/
│   ├── tarotData.ts        # 78张牌的静态数据
│   └── aiClient.ts         # Gemini API 调用封装
└── styles/
    └── global.css          # Tailwind @apply
```
